@model PlaceViewModel
@{
    ViewBag.Title = "";
}

<div class="site-blocks-cover bg-primary" style="margin-top: -500px; height: auto;">
    <div class="container" style="height: auto;">
        <div class="row" style="height: auto;">
            <div class="col-md-12">
                <div class="form-search-wrap mb-0" data-aos="fade-down" data-aos-delay="500">
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-12">

                                <div id="carouselExampleIndicators" class="carousel slide rounded" data-ride="carousel">
                                    <div class="carousel-inner position-relative rounded" style="box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
                                        <div class="carousel-item active">
                                            <img class="d-block w-100" src="~/Images/@Model.Images[0]" alt="First slide" style="height: 600px">
                                        </div>
                                        <div class="carousel-item">
                                            <img class="d-block w-100" src="~/Images/@Model.Images[1]" alt="Second slide" style="height: 600px">
                                        </div>
                                        <div class="carousel-item">
                                            <img class="d-block w-100" src="~/Images/@Model.Images[0]" alt="Third slide" style="height: 600px">
                                        </div>
                                        <div class="position-absolute pl-4 pt-2 pb-2"
                                             style="width: 100%; bottom: 0px; background-color:rgba(0, 0, 0, 0.60);">

                                            <div class="container row align-items-center">
                                                <div class="col-lg-12">
                                                    <div class="font-weight-bold text-primary" style="font-size: 3vw; color: orange;">@Model.Name</div>

                                                    <span class="fa fa-map-marker text-white fa-lg" style="font-size: 2vw;">&nbsp</span>
                                                    <span class="text-white" style="font-size: 2vw;">@(Model.AddressInfo + ", " + Model.AddressDistrict + ", " + Model.AddressProvinceCity)</span>
                                                    <br />
                                                    <span class="fa fa-phone text-white fa-lg" style="font-size: 2vw;">&nbsp</span>
                                                    <span class="text-white" style="font-size: 2vw;">@Model.ContactPhoneNumber1</span>
                                                    <span class="text-white">&nbsp&nbsp&nbsp&nbsp&nbsp</span>
                                                    <span class="fa fa-phone text-white fa-lg" style="font-size: 2vw;">&nbsp</span>
                                                    <span class="text-white" style="font-size: 2vw;">@Model.ContactPhoneNumber2</span>


                                                    <p class="mt-0">
                                                        <span style="font-size: 1.5vw;" class="icon-star text-warning"></span>
                                                        <span style="font-size: 1.5vw;" class="icon-star text-warning"></span>
                                                        <span style="font-size: 1.5vw;" class="icon-star text-warning"></span>
                                                        <span style="font-size: 1.5vw;" class="icon-star text-warning"></span>
                                                        <span style="font-size: 1.5vw;" class="icon-star text-secondary"></span>
                                                        <span style="font-size: 1.5vw;" class="review">(3 Reviews)</span>
                                                    </p>
                                                </div>

                                                @*<div class="col-lg-2">
                                                        <div class="btn-lg btn-primary text-center"
                                                             style="">Đặt sân</div>
                                                    </div>*@
                                            </div>

                                        </div>
                                    </div>
                                    <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev" style="height: 20%; top: 50%; transform: translateY(-50%)">
                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                        <span class="sr-only">Previous</span>
                                    </a>
                                    <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next" style="height: 20%; top: 50%; transform: translateY(-50%)">
                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                        <span class="sr-only">Next</span>
                                    </a>
                                </div>

                            </div>
                        </div>
                        <div class="row">

                            <div class="col-lg-5 p-3">
                                <div class="rounded bg-light" style="box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
                                    <!-- Header -->
                                    <div class="bg-primary rounded-top p-1">
                                        <p class="text-center text-white text-uppercase m-2" style="font-weight: bold">Bảng giá sân</p>
                                    </div>


                                    @{var priceList = ViewBag.PriceList as PlacePriceListViewModel;}

                                    <!--Monday-->
                                    <div class="">
                                        <a href="#monday" class="btn btn-secondary container-fluid" data-toggle="collapse">Thứ 2</a>
                                        <div id="monday" class="collapse">
                                            @foreach (var p in priceList.Monday)
                                            {
                                                <table>
                                                    <tr>
                                                        <td class="pl-5 pr-4 border-0 text-left align-text-top">@p.FieldTypeName</td>
                                                        <td class="pr-0 text-left border-0" style="font-size: .7rem;">
                                                            @{
                                                                var dpl = new DatePriceList(p.DayPrice);
                                                                for (int i = 0; i < dpl.SpanCount; i++)
                                                                {
                                                                    float beginHour;
                                                                    float endHour;
                                                                    float price = dpl.SpanPrice(i, out beginHour, out endHour);

                                                                    @DatePriceList.FormatHour(beginHour)
                                                                    @(" - ")
                                                                    @DatePriceList.FormatHour(endHour)
                                                                    @(" : ")
                                                                    @price
                                                                    @(".000 VNĐ/h")
                                                                    <br>
                                                                }
                                                            }
                                                        </td>
                                                    </tr>
                                                </table>
                                            }
                                        </div>
                                    </div>
                                    <!--Tuesday-->
                                    <div class="">
                                        <a href="#tuesday" class="btn btn-secondary container-fluid" data-toggle="collapse">Thứ 3</a>
                                        <div id="tuesday" class="collapse">
                                            @foreach (var p in priceList.Tuesday)
                                            {
                                                <table>
                                                    <tr>
                                                        <td class="pl-5 pr-4 border-0 text-left align-text-top">@p.FieldTypeName</td>
                                                        <td class="pr-0 text-left border-0" style="font-size: .7rem;">
                                                            @{
                                                                var dpl = new DatePriceList(p.DayPrice);
                                                                for (int i = 0; i < dpl.SpanCount; i++)
                                                                {
                                                                    float beginHour;
                                                                    float endHour;
                                                                    float price = dpl.SpanPrice(i, out beginHour, out endHour);

                                                                    @DatePriceList.FormatHour(beginHour)
                                                                    @(" - ")
                                                                    @DatePriceList.FormatHour(endHour)
                                                                    @(" : ")
                                                                    @price
                                                                    @(".000 VNĐ/h")
                                                                    <br>
                                                                }
                                                            }
                                                        </td>
                                                    </tr>
                                                </table>
                                            }
                                        </div>
                                    </div>
                                    <!--Wednesday-->
                                    <div class="">
                                        <a href="#wednesday" class="btn btn-secondary container-fluid" data-toggle="collapse">Thứ 4</a>
                                        <div id="wednesday" class="collapse">
                                            @foreach (var p in priceList.Wednesday)
                                            {
                                                <table>
                                                    <tr>
                                                        <td class="pl-5 pr-4 border-0 text-left align-text-top">@p.FieldTypeName</td>
                                                        <td class="pr-0 text-left border-0" style="font-size: .7rem;">
                                                            @{
                                                                var dpl = new DatePriceList(p.DayPrice);
                                                                for (int i = 0; i < dpl.SpanCount; i++)
                                                                {
                                                                    float beginHour;
                                                                    float endHour;
                                                                    float price = dpl.SpanPrice(i, out beginHour, out endHour);

                                                                    @DatePriceList.FormatHour(beginHour)
                                                                    @(" - ")
                                                                    @DatePriceList.FormatHour(endHour)
                                                                    @(" : ")
                                                                    @price
                                                                    @(".000 VNĐ/h")
                                                                    <br>
                                                                }
                                                            }
                                                        </td>
                                                    </tr>
                                                </table>
                                            }
                                        </div>
                                    </div>
                                    <!--Thursday-->
                                    <div class="">
                                        <a href="#thursday" class="btn btn-secondary container-fluid" data-toggle="collapse">Thứ 5</a>
                                        <div id="thursday" class="collapse">
                                            @foreach (var p in priceList.Thursday)
                                            {
                                                <table>
                                                    <tr>
                                                        <td class="pl-5 pr-4 border-0 text-left align-text-top">@p.FieldTypeName</td>
                                                        <td class="pr-0 text-left border-0" style="font-size: .7rem;">
                                                            @{
                                                                var dpl = new DatePriceList(p.DayPrice);
                                                                for (int i = 0; i < dpl.SpanCount; i++)
                                                                {
                                                                    float beginHour;
                                                                    float endHour;
                                                                    float price = dpl.SpanPrice(i, out beginHour, out endHour);

                                                                    @DatePriceList.FormatHour(beginHour)
                                                                    @(" - ")
                                                                    @DatePriceList.FormatHour(endHour)
                                                                    @(" : ")
                                                                    @price
                                                                    @(".000 VNĐ/h")
                                                                    <br>
                                                                }
                                                            }
                                                        </td>
                                                    </tr>
                                                </table>
                                            }
                                        </div>
                                    </div>
                                    <!--Friday-->
                                    <div class="">
                                        <a href="#friday" class="btn btn-secondary container-fluid" data-toggle="collapse">Thứ 6</a>
                                        <div id="friday" class="collapse">
                                            @foreach (var p in priceList.Friday)
                                            {
                                                <table>
                                                    <tr>
                                                        <td class="pl-5 pr-4 border-0 text-left align-text-top">@p.FieldTypeName</td>
                                                        <td class="pr-0 text-left border-0" style="font-size: .7rem;">
                                                            @{
                                                                var dpl = new DatePriceList(p.DayPrice);
                                                                for (int i = 0; i < dpl.SpanCount; i++)
                                                                {
                                                                    float beginHour;
                                                                    float endHour;
                                                                    float price = dpl.SpanPrice(i, out beginHour, out endHour);

                                                                    @DatePriceList.FormatHour(beginHour)
                                                                    @(" - ")
                                                                    @DatePriceList.FormatHour(endHour)
                                                                    @(" : ")
                                                                    @price
                                                                    @(".000 VNĐ/h")
                                                                    <br>
                                                                }
                                                            }
                                                        </td>
                                                    </tr>
                                                </table>
                                            }
                                        </div>
                                    </div>
                                    <!--Saturday-->
                                    <div class="">
                                        <a href="#saturday" class="btn btn-secondary container-fluid" data-toggle="collapse">Thứ 7</a>
                                        <div id="saturday" class="collapse">
                                            @foreach (var p in priceList.Saturday)
                                            {
                                                <table>
                                                    <tr>
                                                        <td class="pl-5 pr-4 border-0 text-left align-text-top">@p.FieldTypeName</td>
                                                        <td class="pr-0 text-left border-0" style="font-size: .7rem;">
                                                            @{
                                                                var dpl = new DatePriceList(p.DayPrice);
                                                                for (int i = 0; i < dpl.SpanCount; i++)
                                                                {
                                                                    float beginHour;
                                                                    float endHour;
                                                                    float price = dpl.SpanPrice(i, out beginHour, out endHour);

                                                                    @DatePriceList.FormatHour(beginHour)
                                                                    @(" - ")
                                                                    @DatePriceList.FormatHour(endHour)
                                                                    @(" : ")
                                                                    @price
                                                                    @(".000 VNĐ/h")
                                                                    <br>
                                                                }
                                                            }
                                                        </td>
                                                    </tr>
                                                </table>
                                            }
                                        </div>
                                    </div>
                                    <!--Sunday-->
                                    <div class="">
                                        <a href="#sunday" class="btn btn-secondary container-fluid" data-toggle="collapse">Chủ nhật</a>
                                        <div id="sunday" class="collapse">
                                            @foreach (var p in priceList.Sunday)
                                            {
                                                <table>
                                                    <tr>
                                                        <td class="pl-5 pr-4 border-0 text-left align-text-top">@p.FieldTypeName</td>
                                                        <td class="pr-0 text-left border-0" style="font-size: .7rem;">
                                                            @{
                                                                var dpl = new DatePriceList(p.DayPrice);
                                                                for (int i = 0; i < dpl.SpanCount; i++)
                                                                {
                                                                    float beginHour;
                                                                    float endHour;
                                                                    float price = dpl.SpanPrice(i, out beginHour, out endHour);

                                                                    @DatePriceList.FormatHour(beginHour)
                                                                    @(" - ")
                                                                    @DatePriceList.FormatHour(endHour)
                                                                    @(" : ")
                                                                    @price
                                                                    @(".000 VNĐ/h")
                                                                    <br>
                                                                }
                                                            }
                                                        </td>
                                                    </tr>
                                                </table>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-7 p-3">
                                <!---->
                                <div class="rounded" style="box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
                                    <!-- Header -->
                                    <a href="#order" class="rounded-top p-1 btn w-100" style="background-color: orange" data-toggle="collapse">
                                        <p class="text-center text-white text-uppercase m-2" style="font-weight: bold">Đặt sân ngay</p>
                                    </a>

                                    <!---->
                                    <div id="order" class="collapse">
                                        <div class="position-relative" style="min-height: 320px; padding-bottom: 80px;">

                                            <!--Date-->
                                            <div class="w-100 text-center" style="font-size: 1.1em;"><b>Chọn ngày</b></div>
                                            <div class="input-group date text-center" data-provide="datepicker" id="orderDatePicker">
                                                <input type="text" id="mydate" class="form-control text-center">
                                                <div class="input-group-addon text-center">
                                                    <span class="glyphicon glyphicon-th"></span>
                                                </div>
                                            </div>

                                            <!--Field-->
                                            <div class="w-100 text-center" style="font-size: 1.1em;"><b>Chọn sân</b></div>

                                            <div class="row container justify-content-center align-content-center align-items-center">
                                                @{
                                                    var queue = new Queue<string>();
                                                    queue.Enqueue("A");
                                                    queue.Enqueue("B");
                                                    queue.Enqueue("C");
                                                    queue.Enqueue("D");
                                                    queue.Enqueue("E");
                                                    queue.Enqueue("F");
                                                    queue.Enqueue("G");
                                                    queue.Enqueue("I");
                                                    queue.Enqueue("K");
                                                    queue.Enqueue("L");

                                                    foreach (var f in ViewBag.FieldList as List<FieldViewModel>)
                                                    {
                                                        <div class="col">
                                                            <label class="col" style="position: relative; width: 100px; height: 80px; cursor: pointer; left: 50%; transform: translateX(-50%);">
                                                                <input type="radio" name="field" value="@f.Id" checked>
                                                                <img class="position-absolute" src="~/Images/football-field.png" width="100" height="80">
                                                                <span class="w-100 text-center" style="position: absolute; top: 50%; transform: translateY(-50%); color: red; font-size: 1.2em;">
                                                                    <b>@queue.Dequeue()</b><br />
                                                                    <mark class="bg-primary text-light">@f.FieldTypeName</mark>
                                                                </span>
                                                            </label>
                                                        </div>
                                                    }
                                                }


                                            </div>

                                            <!--Time-->
                                            <div class="container row w-100 text-center" style="font-size: 1.1em;">
                                                <div class="col-lg text-center">
                                                    <b>Thời gian bắt đầu: </b>
                                                    <br/>
                                                    <select id="beginHourSelector">
                                                        <option>1 giờ</option>
                                                        <option>2 giờ 30</option>
                                                    </select>
                                                </div>
                                                <div class="col-lg text-center">
                                                    <b>Thời lượng: </b>
                                                    <br />
                                                    <select id="durationSelector">
                                                        <option>1 tiếng</option>
                                                        <option>1 tiếng 30 phút</option>
                                                        <option>2 tiếng</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <!-- Price -->

                                            <div style="position:absolute; bottom: 5px; left: 50%; transform: translateX(-50%)">
                                                <div class="text-center">Giá: <span id="price">0</span> .000 VND</div>
                                                <div class="btn btn-primary rounded" style="font-size: 1.1em;">Hoàn tất</div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                                <!--Map-->
                                <div class="rounded bg-light mt-4"
                                     style="box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
                                    <div style="width: 100%;">
                                        <iframe src="https://maps.google.com/maps?q=10.9640369,106.7461385&t=&z=13&ie=UTF8&iwloc=&output=embed" frameborder="0"
                                                style="border:0; width: 100%; height: 290px" allowfullscreen></iframe>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    class DatePriceList {
        constructor(obj) {
            obj && Object.assign(this, obj);
        }

        // Methods
        Price(beginHour, duration) {
            var endHour = beginHour + duration;

            //if (endHour > 24.0) throw new DatePriceListException("DatePriceList.Price params invalid");

            var openTime = this.SpanTimes[0];
            var closeTime = this.SpanTimes[this.SpanTimes.length - 1];
            /*
            if (!(openTime <= beginHour && beginHour < endHour && endHour <= closeTime)) {
                throw new Exception("beginHour and endHour are invalid!");
            }
            */
            var price = 0;
            for (var i = 0; i < this.SpanTimes.length; i++)
            {
                if (beginHour < this.SpanTimes[i]) {
                    if (this.SpanTimes[i] >= endHour) {
                        price = (endHour - beginHour) * this.SpanPrices[i - 1];
                        break;
                    }
                    else {
                        // Head
                        price = (this.SpanTimes[i] - beginHour) * this.SpanPrices[i - 1];

                        // Body
                        i++;
                        for (; i < this.SpanTimes.length; i++) {
                            if (endHour > this.SpanTimes[i]) {
                                price += (this.SpanTimes[i] - this.SpanTimes[i - 1]) * this.SpanPrices[i - 1];
                            }
                            else break;
                        }

                        // Footer
                        price += (endHour - this.SpanTimes[i - 1]) * this.SpanPrices[i - 1];
                        break;
                    }
                }
            }
            return price;
        }
    }
</script>
<script>
    var durationData;
    var datePriceList;

    $(document).ready(function () {
        $("#orderDatePicker")
            .datepicker({
                format: 'dd/mm/yyyy',
                startDate: '+0d',
                endDate: '+10d'
            })
            .datepicker('setDate', new Date())
            .on("changeDate", function (e) {
                fetchData();
            });

        //
        $('input[type=radio][name=field]').change(function () {
            fetchData();
        });
        $("#beginHourSelector").change(function () {
            refeshDuration();
        });
        $("#durationSelector").change(function () {
            refeshPrice();
        });

        var refeshDuration = function () {
            var a = $("#beginHourSelector");
            var duration = $("#durationSelector")
                .find("option")
                .remove()
                .end();

            durationData[a.find(":selected").val()].forEach(function (item, index) {
                var s = Math.floor(item) + " tiếng ";
                if (item * 60 % 60 > 0) {
                    s += item * 60 % 60 + " phút";
                }
                duration.append(new Option(s, item));
            });

            refeshPrice();
        }

        var refeshPrice = function () {
            var beginHour = $("#beginHourSelector").find(":selected").val();
            var duration = $("#durationSelector").find(":selected").val();
            $("#price").html(datePriceList.Price(Number(beginHour), Number(duration)));
        }

        var fetchData = function () {

            fieldid = $('input[type=radio][name=field]:checked').val();

            var date = $("#orderDatePicker").datepicker('getDate');
            dateString = date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear();

            $.ajax({
                type: "GET",
                url: "/api/schedule-order/get-all-possible-schedule-order-time",
                //contentType: "application/json; charset=utf-8",
                data: {
                    fieldid: fieldid,
                    DateString: dateString
                },
                dataType: "json",
                success: function (result, status, xhr) {
                    // Date price list
                    datePriceList = new DatePriceList(result.datePriceList);

                    // begin hour
                    var a = $("#beginHourSelector")
                        .find("option")
                        .remove()
                        .end();

                    result.possibleOrder.forEach(function (item, index) {
                        var s = Math.floor(item.begin_hour) + " giờ ";
                        if (item.begin_hour * 60 % 60 > 0) {
                            s += item.begin_hour * 60 % 60 + " phút";
                        }
                        a.append(new Option(s, item.begin_hour));
                    });

                    // duration
                    durationData = [];
                    result.possibleOrder.forEach(function (item, index) {
                        durationData[item.begin_hour] = [];
                        for (var i = item.min_duration; i <= item.max_duration; i += 0.5) {
                            durationData[item.begin_hour].push(i);
                        }
                    });

                    refeshDuration();
                    refeshPrice();
                },
                error: function (xhr, status, error) {
                    //$("#data").html("Result: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
                }
            });
        }


        fetchData();
    });
</script>